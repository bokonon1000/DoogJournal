<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SECURE SYSTEM</title>
    <style>
        :root { --bg-blue: #0000AA; --text-white: #FFFFFF; --highlight-yellow: #FFFF55; --danger-red: #FF5555; }
        
        body { 
            background: var(--bg-blue); 
            color: var(--text-white); 
            font-family: 'Lucida Console', monospace; 
            margin: 0; 
            padding: 15px; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            touch-action: manipulation;
        }
        
        #lock-screen { position: fixed; inset: 0; background: var(--bg-blue); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-box { border: 4px double var(--text-white); padding: 20px; text-align: center; width: 85%; max-width: 320px; box-shadow: 8px 8px 0px #000; }
        
        input[type="password"] { 
            background: var(--bg-blue); 
            color: var(--highlight-yellow); 
            border: 2px solid var(--text-white); 
            padding: 12px; 
            width: 90%; 
            font-size: 16px; 
            text-align: center; 
            margin: 15px 0; 
            outline: none; 
            border-radius: 0;
        }
        
        #main-ui { width: 100%; max-width: 600px; display: none; padding-bottom: 120px; }
        
        textarea#diaryInput { 
            width: 100%; 
            height: 140px; 
            background: var(--bg-blue); 
            color: #FFF; 
            border: 2px solid #FFF; 
            padding: 12px; 
            font-family: inherit; 
            box-sizing: border-box; 
            outline: none; 
            font-size: 16px; 
            line-height: 1.4;
            border-radius: 0;
        }
        
        .entry-container { margin-top: 20px; border-left: 3px solid #FFF; padding: 10px; background: rgba(255,255,255,0.05); }
        .entry-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .ts-edit { background: transparent; border: none; color: var(--highlight-yellow); font-family: inherit; font-size: 14px; width: 75%; padding: 4px; outline: none; }
        
        .edit-area { 
            width: 100%; 
            background: transparent; 
            color: #FFF; 
            border: none; 
            font-family: inherit; 
            font-size: 16px; 
            resize: none; 
            outline: none; 
            line-height: 1.4; 
            overflow: hidden; /* Prevent double scrollbars */
            display: block;
        }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #AAA; display: flex; padding: 10px 0; z-index: 1100; border-top: 2px solid #000; }
        .nav-btn { background: #CCC; color: #000; border: 2px outset #EEE; padding: 10px 1px; font-size: 11px; font-weight: bold; flex: 1; margin: 0 2px; text-align: center; text-transform: uppercase; cursor: pointer; height: 48px; display: flex; align-items: center; justify-content: center; }
        
        .wipe-btn { background: #600; color: #FFF; border: 2px solid white; padding: 10px; width: 100%; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="login-box">
        <div style="color:var(--danger-red); font-weight: bold; margin-bottom: 10px;">** SYSTEM LOCKED **</div>
        <input type="password" id="sys-pass" placeholder="ENTER CODE" inputmode="numeric">
        <button id="login-btn" onclick="preLogin()" style="width:100%; padding:15px; font-weight:bold; cursor:pointer; background:white; color:var(--bg-blue); border:none;">ACCESS SYSTEM</button>
        <div id="status-msg" style="margin-top:10px; font-size:12px; color:var(--highlight-yellow);">STATUS: STANDBY</div>
        <button class="wipe-btn" onclick="if(confirm('Wipe data?')){localStorage.clear(); location.reload();}">INSTANT EMERGENCY WIPE</button>
    </div>
</div>

<div id="main-ui">
    <div style="text-align:center; margin-bottom: 15px;">
        <div id="timer-display" style="color:var(--danger-red); font-size:14px; font-weight:bold; text-transform: uppercase;">COUNTDOWN TO AUTOLOCK: 15:00</div>
        <div style="border: 2px solid white; padding: 10px; margin-top:5px; font-weight:bold; letter-spacing: 1px;">JOURNAL OF BRANDON M PUTZ</div>
    </div>

    <textarea id="diaryInput" placeholder="ENTER LOG DATA..."></textarea>
    
    <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--highlight-yellow); padding:8px 0; border-bottom: 1px solid #FFF;">
        <span id="char-count">CHARS: 0</span>
        <span id="log-count">TOTAL LOGS: 0</span>
    </div>
    <div id="history"></div>
</div>

<div class="bottom-nav" id="mobile-nav" style="display:none;">
    <div class="nav-btn" onclick="exportData()">BACKUP</div>
    <div class="nav-btn" onclick="location.reload()">LOCK</div>
    <div class="nav-btn" onclick="rekeySystem()">RE-KEY</div>
    <div class="nav-btn" onclick="document.getElementById('file-in').click()">RESTORE</div>
    <div class="nav-btn" onclick="saveEntry()">SAVE</div>
    <div class="nav-btn" onclick="toggleSort()">SORT</div>
    <input type="file" id="file-in" style="display:none" onchange="importData(this)">
</div>

<script>
    let SESSION_KEY = null, ENTRIES = [], sortDesc = true, timeLeft = 900;

    // Fixed: Properly defined the autoResize function within the script
    function autoResize(el) {
        if (!el) return;
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    document.getElementById('sys-pass').addEventListener('keypress', (e) => { if(e.key === 'Enter') preLogin(); });
    document.getElementById('diaryInput').oninput = function() {
        document.getElementById('char-count').innerText = `CHARS: ${this.value.length}`;
    };

    async function deriveKey(p) {
        const enc = new TextEncoder();
        const salt = enc.encode("bp-salt-v10");
        const base = await crypto.subtle.importKey("raw", enc.encode(p), "PBKDF2", false, ["deriveKey"]);
        return crypto.subtle.deriveKey(
            {name:"PBKDF2", salt: salt, iterations: 2000, hash:"SHA-256"}, 
            base, 
            {name:"AES-GCM", length:256}, 
            false, 
            ["encrypt","decrypt"]
        );
    }

    function preLogin() {
        const btn = document.getElementById('login-btn');
        const msg = document.getElementById('status-msg');
        const input = document.getElementById('sys-pass');
        if(!input.value) return;
        btn.disabled = true;
        btn.innerText = "WAITING...";
        msg.innerText = "STATUS: INITIALIZING...";
        input.blur(); 
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                setTimeout(executeLogin, 100);
            });
        });
    }

    async function executeLogin() {
        const p = document.getElementById('sys-pass').value;
        const msg = document.getElementById('status-msg');
        const btn = document.getElementById('login-btn');
        try {
            SESSION_KEY = await deriveKey(p);
            const stored = localStorage.getItem('bp_v10_vault');
            if(stored) {
                const {iv, data} = JSON.parse(atob(stored));
                const rawData = new Uint8Array(atob(data).split("").map(c => c.charCodeAt(0)));
                const dec = await crypto.subtle.decrypt({name:"AES-GCM", iv: new Uint8Array(iv)}, SESSION_KEY, rawData);
                ENTRIES = JSON.parse(new TextDecoder().decode(dec));
            }
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            document.getElementById('mobile-nav').style.display = 'flex';
            render();
            startTimer();
        } catch(e) { 
            msg.innerText = "STATUS: ACCESS DENIED";
            btn.innerText = "ACCESS SYSTEM";
            btn.disabled = false;
            document.getElementById('sys-pass').value = "";
        }
    }

    function startTimer() {
        setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer-display').innerText = `COUNTDOWN TO AUTOLOCK: ${m}:${s.toString().padStart(2,'0')}`;
            if(timeLeft<=0) location.reload();
        }, 1000);
    }

    async function saveEntry() {
        const txt = document.getElementById('diaryInput').value.trim();
        if(!txt) return;
        const d = new Date();
        const ts = `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}/${d.getFullYear()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        ENTRIES.push({id: Date.now(), date: ts, text: txt});
        await sync();
        document.getElementById('diaryInput').value = "";
        document.getElementById('char-count').innerText = "CHARS: 0";
        render();
    }

    async function sync() {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(JSON.stringify(ENTRIES));
        const enc = await crypto.subtle.encrypt({name:"AES-GCM", iv:iv}, SESSION_KEY, encoded);
        const packed = btoa(JSON.stringify({
            iv: Array.from(iv), 
            data: btoa(String.fromCharCode(...new Uint8Array(enc)))
        }));
        localStorage.setItem('bp_v10_vault', packed);
    }

    function render() {
        const h = document.getElementById('history');
        document.getElementById('log-count').innerText = `TOTAL LOGS: ${ENTRIES.length}`;
        h.innerHTML = "";
        const list = [...ENTRIES].sort((a,b) => sortDesc ? b.id - a.id : a.id - b.id);
        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'entry-container';
            div.innerHTML = `
                <div class="entry-header">
                    <input class="ts-edit" value="${item.date}" onchange="update(${item.id}, this.value, null)">
                    <span style="color:var(--danger-red); font-size:14px; font-weight:bold; cursor:pointer;" onclick="del(${item.id})">[DEL]</span>
                </div>
                <textarea class="edit-area" oninput="autoResize(this); update(${item.id}, null, this.value)">${item.text}</textarea>
            `;
            h.appendChild(div);
            // Trigger autoResize after element is added to DOM
            const textArea = div.querySelector('.edit-area');
            setTimeout(() => autoResize(textArea), 0);
        });
    }

    async function update(id, d, t) {
        const i = ENTRIES.findIndex(e => e.id === id);
        if(d !== null) ENTRIES[i].date = d;
        if(t !== null) ENTRIES[i].text = t;
        await sync();
    }

    async function del(id) { if(confirm("Delete log?")) { ENTRIES = ENTRIES.filter(e=>e.id!==id); await sync(); render(); } }
    function toggleSort() { sortDesc = !sortDesc; render(); }
    
    function exportData() {
        const data = localStorage.getItem('bp_v10_vault');
        if(!data) return;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([data], {type:'text/plain'}));
        a.download = `backup_${Date.now()}.txt`;
        a.click();
    }

    async function rekeySystem() {
        const p = prompt("Enter NEW encryption code:");
        if (p) {
            SESSION_KEY = await deriveKey(p);
            await sync();
            alert("System Re-Keyed.");
        }
    }

    async function importData(el) {
        const p = prompt("File Code:");
        if(!p) return;
        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const key = await deriveKey(p);
                const {iv, data} = JSON.parse(atob(reader.result));
                const dec = await crypto.subtle.decrypt({name:"AES-GCM", iv:new Uint8Array(iv)}, key, new Uint8Array(atob(data).split("").map(c=>c.charCodeAt(0))));
                ENTRIES = JSON.parse(new TextDecoder().decode(dec));
                await sync();
                render();
            } catch(e) { alert("Fail."); }
        };
        reader.readAsText(el.files[0]);
    }
</script>
</body>
</html>