<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE SYSTEM - BRANDON PUTZ</title>
    <style>
        body { background-color: #0000AA; color: #FFFFFF; font-family: 'Lucida Console', Monaco, monospace; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0000AA; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { border: 4px double #FFFFFF; padding: 40px; text-align: center; background: #0000AA; box-shadow: 10px 10px 0px #000000; width: 350px; }
        #main-ui { width: 100%; max-width: 650px; display: none; padding-top: 20px; }
        input[type="password"] { background: #0000AA; color: #FFFF55; border: 2px solid #FFFFFF; padding: 10px; font-family: 'Lucida Console', monospace; text-align: center; margin: 15px 0; width: 85%; font-size: 1.2rem; outline: none; }
        button { background-color: #FFFFFF; color: #0000AA; border: none; padding: 8px 10px; font-weight: bold; cursor: pointer; font-family: 'Lucida Console', monospace; font-size: 0.75rem; }
        .tool-bar { display: flex; gap: 5px; padding: 10px 0; justify-content: space-between; margin: 20px 0; }
        #timer-display { color: #FF5555; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .stats-bar { color: #FFFF55; font-size: 0.8rem; margin-bottom: 10px; border-bottom: 1px solid #FFFFFF; padding-bottom: 5px; width: 100%; display: flex; justify-content: space-between; }
        .entry-container { margin-bottom: 30px; border-left: 3px solid #FFFFFF; padding-left: 15px; }
        .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .date-input { background: transparent; border: none; color: #AAAAAA; font-family: 'Lucida Console', monospace; font-size: 0.75rem; width: 50%; outline: none; }
        .char-tag { color: #55FF55; font-size: 0.65rem; }
        .edit-area { width: 100%; background: transparent; color: #FFFFFF; border: none; font-family: 'Lucida Console', monospace; font-size: 0.95rem; resize: none; outline: none; overflow: hidden; line-height: 1.5; }
        .del-btn { color: #FF5555; cursor: pointer; font-weight: bold; font-size: 0.7rem; border: 1px solid #FF5555; padding: 2px 4px; }
        .reset-link { margin-top: 40px; background: none; color: #666666; text-decoration: underline; border: none; cursor: pointer; font-size: 0.65rem; }
        textarea#diaryInput { width: 100%; height: 120px; background: #0000AA; color: #FFFFFF; border: 2px solid #FFFFFF; padding: 10px; font-family: 'Lucida Console', monospace; outline: none; box-sizing: border-box; }
        .input-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #FFFF55; margin-top: 5px; align-items: center; }
        .key-legend { position: fixed; bottom: 0; width: 100%; background: #AAAAAA; color: #000000; padding: 4px; font-size: 0.7rem; text-align: center; z-index: 1100; }
    </style>
</head>
<body onmousedown="resetTimer()" onkeydown="resetTimer()">

<div id="lock-screen">
    <div class="login-box">
        <div style="color:#FF5555; font-weight: bold; margin-bottom: 10px;">** SYSTEM LOCKED **</div>
        <input type="password" id="sys-pass" placeholder="CODE" autofocus onkeydown="if(event.key==='Enter') login()">
        <div><button onclick="login()" style="width: 90%; padding: 12px;">ACCESS SYSTEM</button></div>
        <div id="login-status" style="margin-top:10px; font-weight:bold; height: 20px;"></div>
        <button class="reset-link" onclick="forceReset()">[!] EMERGENCY WIPE / START FRESH</button>
    </div>
</div>

<div id="main-ui">
    <div id="timer-display">AUTO-LOCK IN: 15:00</div>
    <div style="text-align:center; color:#FF5555; font-weight:bold; margin-bottom:15px;">
        <div>**********************************************</div>
        <div style="color:white; margin:5px 0;">PERSONAL JOURNAL OF BRANDON PUTZ</div>
        <div>**********************************************</div>
    </div>
    
    <textarea id="diaryInput" placeholder="TYPE SECURE LOG..." oninput="updateLiveCount()"></textarea>
    <div class="input-meta">
        <span id="liveCharCount">CHARS: 0</span>
        <button onclick="saveEntry()" style="padding: 10px 25px; background:white; color:#0000AA;">ðŸ’¾ SAVE (F2)</button>
    </div>
    
    <div class="tool-bar">
        <button onclick="exportEncrypted()">ðŸ–´ BACKUP (F8)</button>
        <button onclick="location.reload()">ðŸ”’ LOGOUT (F12)</button>
        <button onclick="rekeySystem()">ðŸ”‘ RE-KEY (F10)</button>
        <button onclick="document.getElementById('fileInput').click()">ðŸ“‚ RESTORE (F9)</button>
        <button onclick="toggleSort()">ðŸ”„ SORT (F5)</button>
        <input type="file" id="fileInput" style="display:none" onchange="importEncrypted(this)">
    </div>

    <div class="stats-bar">
        <span id="statsDisplay">TOTAL LOGS: 0</span>
        <span>ENCRYPTION: AES-256-GCM</span>
    </div>
    <div id="history"></div>
</div>

<div class="key-legend">F2: SAVE | F8: BACKUP | F12: LOGOUT | F10: RE-KEY | F9: RESTORE | F5: SORT</div>

<script>
    let SESSION_KEY = null;
    let ENTRIES = [];
    let sortDescending = true;
    let timeLeft = 900;
    let timerInterval = null;

    async function deriveKey(password) {
        const enc = new TextEncoder();
        const baseKey = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
        return crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: enc.encode("bp-salt-v10"), iterations: 100000, hash: "SHA-256" },
            baseKey, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
        );
    }

    async function encrypt(data, key) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(JSON.stringify(data));
        const ciphertext = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, encoded);
        return btoa(JSON.stringify({ iv: Array.from(iv), data: btoa(String.fromCharCode(...new Uint8Array(ciphertext))) }));
    }

    async function decrypt(packed, key) {
        const { iv, data } = JSON.parse(atob(packed));
        const decrypted = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv: new Uint8Array(iv) },
            key, new Uint8Array(atob(data).split("").map(c => c.charCodeAt(0)))
        );
        return JSON.parse(new TextDecoder().decode(decrypted));
    }

    async function login() {
        const pass = document.getElementById('sys-pass').value;
        if (!pass) return;
        try {
            const key = await deriveKey(pass);
            const stored = localStorage.getItem('bp_v10_vault');
            if (stored) {
                ENTRIES = await decrypt(stored, key);
            }
            SESSION_KEY = key;
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            displayEntries();
            startTimer();
        } catch (e) {
            document.getElementById('login-status').innerHTML = '<span style="color:#FF5555">ACCESS DENIED</span>';
            document.getElementById('sys-pass').value = "";
        }
    }

    function resetTimer() { timeLeft = 900; }
    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            let mins = Math.floor(timeLeft / 60);
            let secs = timeLeft % 60;
            document.getElementById('timer-display').innerText = `AUTO-LOCK IN: ${mins}:${secs.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) location.reload();
        }, 1000);
    }

    function updateLiveCount() {
        document.getElementById('liveCharCount').innerText = `CHARS: ${document.getElementById('diaryInput').value.length}`;
    }

    async function saveToVault(data) {
        const packed = await encrypt(data, SESSION_KEY);
        localStorage.setItem('bp_v10_vault', packed);
    }

    async function saveEntry() {
        const text = document.getElementById('diaryInput').value.trim();
        if (!text) return;
        const n = new Date();
        const ts = `${(n.getMonth()+1).toString().padStart(2,'0')}/${n.getDate().toString().padStart(2,'0')}/${n.getFullYear()} ${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`;
        ENTRIES.push({ id: Date.now(), date: ts, text: text });
        await saveToVault(ENTRIES);
        document.getElementById('diaryInput').value = "";
        updateLiveCount();
        displayEntries();
        resetTimer();
    }

    function displayEntries() {
        const container = document.getElementById('history');
        document.getElementById('statsDisplay').innerText = `TOTAL LOGS: ${ENTRIES.length}`;
        container.innerHTML = "";
        const sorted = [...ENTRIES].sort((a,b) => sortDescending ? b.id - a.id : a.id - b.id);
        sorted.forEach(item => {
            const div = document.createElement('div');
            div.className = 'entry-container';
            div.innerHTML = `
                <div class="entry-header">
                    <div>
                        <input class="date-input" value="${item.date}" onblur="updateEntry(${item.id}, this.value, null)">
                        <span class="char-tag">[${item.text.length} chars]</span>
                    </div>
                    <span class="del-btn" onclick="deleteEntry(${item.id})">DELETE</span>
                </div>
                <textarea class="edit-area" onblur="updateEntry(${item.id}, null, this.value)">${item.text}</textarea>
            `;
            container.appendChild(div);
            const ta = div.querySelector('textarea');
            ta.style.height = ta.scrollHeight + 'px';
        });
    }

    async function updateEntry(id, d, t) {
        const idx = ENTRIES.findIndex(e => e.id === id);
        if (d !== null) ENTRIES[idx].date = d;
        if (t !== null) ENTRIES[idx].text = t;
        await saveToVault(ENTRIES);
        displayEntries();
    }

    async function deleteEntry(id) {
        if (confirm("Delete?")) {
            ENTRIES = ENTRIES.filter(e => e.id !== id);
            await saveToVault(ENTRIES);
            displayEntries();
        }
    }

    function toggleSort() { sortDescending = !sortDescending; displayEntries(); }
    
    function exportEncrypted() {
        const data = localStorage.getItem('bp_v10_vault');
        const blob = new Blob([data], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_${Date.now()}.txt`;
        a.click();
    }

    async function importEncrypted(el) {
        const pass = prompt("File password:");
        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const key = await deriveKey(pass);
                ENTRIES = await decrypt(reader.result, key);
                await saveToVault(ENTRIES);
                displayEntries();
                alert("Done.");
            } catch(e) { alert("Fail."); }
        };
        reader.readAsText(el.files[0]);
    }

    async function rekeySystem() {
        const p = prompt("New code:");
        if (p) {
            SESSION_KEY = await deriveKey(p);
            await saveToVault(ENTRIES);
            alert("Changed.");
        }
    }

    function forceReset() { if(confirm("Wipe?")) { localStorage.clear(); location.reload(); } }

    window.onkeydown = e => {
        if(e.key === "F2") { e.preventDefault(); saveEntry(); }
        if(e.key === "F5") { e.preventDefault(); toggleSort(); }
        if(e.key === "F8") { e.preventDefault(); exportEncrypted(); }
        if(e.key === "F10") { e.preventDefault(); rekeySystem(); }
        if(e.key === "F12") { location.reload(); }
    };
</script>
</body>
</html>
